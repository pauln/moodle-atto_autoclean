YUI.add("moodle-atto_autoclean-button",function(e,t){e.namespace("M.atto_autoclean").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_originalContent:null,initializer:function(){this.editor.on("paste",this.startCapture,this)},startCapture:function(t){var n=this.get("host");n.insertContentAtFocusPoint('<span class="_atto_autoclean_placeholder"></span>'),this._originalContent=n.editor.getHTML(),n.editor.setHTML(""),e.soon(e.bind(this.endCapture,this))},endCapture:function(){var t=this.get("host"),n=rangy.createRange(),r,i;dummy=e.Node.create('<div id="_atto_autoclean_pasted_content" style="height:1px;position:absolute;left:-10000px;">'+t.editor.getHTML()+"</div>"),t.editor.insert(dummy,"after"),t.editor.set("innerHTML",this._originalContent),r=t.editor.one("._atto_autoclean_placeholder"),n.selectNode(r.getDOMNode()),dummy.getHTML().length?(this.preClean(dummy),this.fixLists(dummy),dummy.all("[style]").each(this.cleanStyles,this),i=this.get("host")._cleanHTML(dummy.getHTML()),t.setSelection([n]),this._insertContentBeforeFocusPoint(i,n)):(n.deleteContents(),t.setSelection([n])),dummy.remove(!0)},preClean:function(t){var n=t.all("span");while(n.size()>0){var r=n.pop();/mso-bookmark/.test(r.getAttribute("style"))&&r.replace(e.Node.create(r.get("innerHTML")))}t.all("font").each(function(t){e.Lang.trim(t.getHTML()).length===0&&t.remove(!0)}),t.all("a").each(function(t){t.hasAttribute("name")&&!t.hasAttribute("href")&&(t.getHTML().length?t.replace(e.Node.create(t.get("innerHTML"))):t.remove(!0))})},fixLists:function(t){var n=!1,r=/mso-list:.+?level(\d+)/,i,s,o;t.get("children").each(function(s){var o=r.exec(s.getAttribute("style"));if(o!==null){var u,a;n||(i=e.Node.create("<ul></ul>"),t.insertBefore(i,s),n=!0),a=s.get("firstChild");while(a.get("nodeType")===8)a=a.get("nextSibling");a.get("nodeName")==="FONT"&&(a=a.get("firstChild")),a.remove(!0),u=e.Node.create("<li>"+s.getHTML()+"</li>"),i.appendChild(u),t.removeChild(s)}else n=!1},this),t.get("children").each(function(e){var t=e.get("nodeName").toUpperCase();t==="UL"&&o==="UL"?(e.get("children").each(function(e){s.appendChild(e)},this),e.remove(!0)):(o=t,s=e)},this)},cleanStyles:function(e){var t,n;t=e.getAttribute("style").split(";"),n="";for(var r=0;r<t.length;r++){var i=t[r].trim();if(!i.length||/^(mso-|tab-stops|font-family)/i.test(i))continue;n+=i+";"}n.length?e.setAttribute("style",n):e.removeAttribute("style")},_insertContentBeforeFocusPoint:function(t,n){var r=e.Node.create(t),i=r.getDOMNode(),s=i,o=this.get("host"),u=o.editor,a,f,l,c;n&&(i.nodeType===11&&(s=i.lastChild),n.deleteContents(),n.insertNode(i),n.collapseAfter(s),o.setSelection([n]),a=u.getStyle("position"),u.setStyle("position","relative"),c=s.offsetTop+s.offsetHeight,u.setStyle("position",a),c+=32,l=u.get("offsetHeight"),f=u.get("scrollTop"),(c<f||c>f+l)&&u.set("scrollTop",c-l))}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
